generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- USER & AUTH ---

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  role          UserRole  @default(STUDENT)
  
  // Cognitive Profile
  ageBand       String    @default("10-12")
  cr            Int       @default(1000)
  countryCode   String?
  toneProfile   String    @default("BALANCED") 
  avatarConfig  Json?     // { base: "robot", color: "blue", accessories: [] }
  
  // Engagement & Retention
  division      Division  @default(BRONZE)
  xp            Int       @default(0)
  level         Int       @default(1)
  winStreak     Int       @default(0)
  
  // Progression
  masteryStates MasteryState[]
  sessions      Session[]
  questState    UserQuestState?
  ladderEntries LadderEntry[]
  animationLogs AnimationUsageLog[]
  dailyChallenges DailyChallengeLog[]
  badges         UserBadge[]
  
  // Privacy & Consent
  consents      PrivacyConsent[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Parent Dashboard (Phase 8)
  childLinkCode String?   @unique // Generated unique code for child to share
  linkedChildId String?
  linkedChild   User?     @relation("ParentChild", fields: [linkedChildId], references: [id])
  parent        User[]    @relation("ParentChild")
  
  dailyAggregates DailySkillAggregate[]
  
  // Global Competition (Phase 9)
  region        Region    @default(IN)
  qualifierEntries QualifierEntry[]
  globalFinalists GlobalFinalist[]
  
  // Monetization (Phase 10)
  coins         Int       @default(0)
  equippedAvatarSku     String?
  equippedFrameSku      String?
  equippedBackgroundSku String?
  equippedEmoteSku      String?
  
  dailyWallets  DailyWallet[]
  cosmetics     UserCosmetic[]
  bpProgress    UserBattlePassProgress[]
  entitlements  Entitlement[]
  purchases     PurchaseLog[]
}

model PrivacyConsent {
  id        String   @id @default(cuid())
  userId    String
  type      String   // e.g. "PARENTAL_CONTROL", "DATA_USAGE"
  agreed    Boolean
  timestamp DateTime @default(now())
  ip        String?
  
  user      User     @relation(fields: [userId], references: [id])
}

// --- REGIONS & LOCALIZATION ---

// Region model removed in favor of Enum for Phase 9
// enum UserRole { ... } follows

enum UserRole {
  STUDENT
  PARENT
  TEACHER
  ADMIN
}

// --- SKILL GRAPH ---

model Skill {
  id            String    @id
  slug          String    @unique
  name          String
  topic         String    // e.g. "Arithmetic", "Algebra"
  tier          Int       // 1 (Basic) to 10 (Advanced)
  
  prerequisites SkillPrerequisite[] @relation("prereq")
  dependentOn   SkillPrerequisite[] @relation("dependency")
  
  blueprints    ContentBlueprint[]
  masteryStates MasteryState[]
  dailyAggregates DailySkillAggregate[]
}

model SkillPrerequisite {
  skillId       String
  prereqId      String
  
  skill         Skill @relation("dependency", fields: [skillId], references: [id])
  prereq        Skill @relation("prereq", fields: [prereqId], references: [id])
  
  @@id([skillId, prereqId])
}

// --- MASTERY ENGINE ---

model MasteryState {
  id              String   @id @default(cuid())
  userId          String
  skillId         String
  
  // The Core Metrics
  score           Float    @default(0) // 0-100 internal mastery
  stability       Int      @default(0) // Consecutive successes impact
  frustration     Float    @default(0) // 0-100 index (speed drops, error spikes)
  
  // Adaptive Learning State
  confidence      Float    @default(0) // 0-100 derived from speed/hesitation
  streak          Int      @default(0) // Current streak (session/local)
  currentDifficulty Float  @default(0) // The adaptive tracking value
  highestDifficultySolved Float @default(0) // Peak performance

  // Engagement Fields
  division        Division @default(BRONZE)
  winStreak       Int      @default(0) // Global/Ranked Persistence
  bestWinStreak   Int      @default(0)
  lastMatchAt     DateTime?

  visibleTier     MasteryTier @default(NOVICE)
  
  lastPracticedAt DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill           Skill    @relation(fields: [skillId], references: [id])

  @@unique([userId, skillId])
}

enum MasteryTier {
  NOVICE
  BRONZE
  SILVER
  GOLD
  PLATINUM
  MASTER
  GRANDMASTER
}

// --- CONTENT & CONTENT GENERATION ---

model ContentBlueprint {
  id          String   @id @default(cuid())
  skillId     String
  difficulty  Int      // 1-100
  generatorId String   // points to code generator function
  params      Json     // Seed params schema
  version     Int      @default(1) // Content versioning
  
  skill       Skill    @relation(fields: [skillId], references: [id])
}

// --- DAILY QUEST LOOP ---

model DailyQuest {
  id          String   @id @default(cuid())
  date        DateTime @db.Date // YYYY-MM-DD
  
  // Global Quest Configuration
  warmupSkillId String?
  challengeSkillId String?
}

model UserQuestState {
  id          String   @id @default(cuid())
  userId      String   @unique
  date        DateTime @db.Date // Current active quest date
  
  // Progress Flags
  warmupDone  Boolean @default(false)
  skillDone   Boolean @default(false)
  practiceDone Boolean @default(false)
  gameDone    Boolean @default(false)
  bonusDone   Boolean @default(false)
  
  user        User    @relation(fields: [userId], references: [id])
}

// --- SESSION ARENA ---

model Session {
  id          String      @id @default(cuid())
  userId      String
  type        SessionType
  status      SessionStatus @default(IN_PROGRESS)
  
  startTime   DateTime    @default(now())
  endTime     DateTime?
  metadata    Json?       // Stores match details (opponentId, targetScore)
  
  // Outcomes
  xpEarned    Int         @default(0)
  crChange    Int         @default(0)
  
  items       SessionItem[]
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum SessionType {
  DIAGNOSTIC
  PRACTICE
  RANKED
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

model SessionItem {
  id          String   @id @default(cuid())
  sessionId   String
  skillId     String
  
  // Snapshot of item
  question    Json     // The generated data
  correctAnswer String
  difficulty  Int
  
  // User Action
  userAnswer  String?
  isCorrect   Boolean  @default(false)
  timeTakenMs Int      @default(0)
  hintsUsed   Int      @default(0)
  
  createdAt   DateTime @default(now())
  
  session     Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

// --- ANIMATION & ENTERTAINMENT ---

model AnimationUsageLog {
  id          String   @id @default(cuid())
  userId      String
  animationId String   // e.g. "sparkle_burst_v1"
  rarity      String   // COMMON, RARE, EPIC, LEGENDARY
  timestamp   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, animationId])
  @@index([userId, timestamp])
}

// --- RANKED LADDER ---

model LadderEntry {
  id          String   @id @default(cuid())
  userId      String
  seasonId    String
  
  league      League   @default(BRONZE)
  division    Int      @default(5) // 5 down to 1
  rankPoints  Int      @default(0)
  
  user        User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, seasonId])
}

enum League {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
  ELITE
}

// --- ENGAGEMENT & RETENTION (PHASE 7) ---

enum Division {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
  MASTER
}

model DailyChallengeLog {
  id        String    @id @default(cuid())
  userId    String
  skillId   String
  score     Int       // 0-10 or percentage
  completed Boolean   @default(true)
  createdAt DateTime  @default(now())
  
  user      User      @relation(fields: [userId], references: [id])
}

model Badge {
  id          String    @id @default(cuid())
  name        String    @unique
  description String
  type        String    // e.g. "ACHIEVEMENT", "MILESTONE"
  icon        String?
  
  userBadges  UserBadge[]
}

model UserBadge {
  id        String    @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime  @default(now())
  
  user      User      @relation(fields: [userId], references: [id])
  badge     Badge     @relation(fields: [badgeId], references: [id])
  
  @@unique([userId, badgeId])
}

// --- PARENT DASHBOARD & ANALYTICS (PHASE 8) ---

model DailySkillAggregate {
  id          String   @id @default(cuid())
  userId      String
  skillId     String
  date        DateTime @db.Date // Store as date only
  attempts    Int      @default(0)
  correct     Int      @default(0)
  avgDuration Int      @default(0) // ms
  hintsUsed   Int      @default(0)
  masteryDelta Int     @default(0) // Change in mastery score
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id])
  skill       Skill    @relation(fields: [skillId], references: [id])

  @@unique([userId, skillId, date])
}

model SafetyEventLog {
  id        String   @id @default(cuid())
  userId    String?
  eventType String   // e.g. "PARENT_LINK_FAIL", "RAPID_SUBMIT"
  details   Json
  createdAt DateTime @default(now())
}

// --- GLOBAL COMPETITION SYSTEM (PHASE 9) ---

enum Region {
  IN
  US
  EU
  SEA
  MEA
  LATAM
}

model Season {
  id        String   @id @default(cuid())
  name      String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
}

model RegionalLadderEntry {
  id          String   @id @default(cuid())
  seasonId    String
  userId      String
  skillId     String
  region      Region
  rating      Int
  division    Division
  rank        Int?       // computed periodically; optional
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@unique([seasonId, userId, skillId])
  @@index([seasonId, skillId, region, rating])
}

model Qualifier {
  id          String   @id @default(cuid())
  seasonId    String
  skillId     String
  region      Region
  weekStart   DateTime
  weekEnd     DateTime
  status      String // "OPEN" | "LOCKED" | "COMPLETED"
  createdAt   DateTime @default(now())

  entries     QualifierEntry[]
  
  @@unique([seasonId, skillId, region, weekStart])
}

model QualifierEntry {
  id           String   @id @default(cuid())
  qualifierId  String
  userId       String
  skillId      String
  region       Region
  seed         Int
  score        Int
  completedAt  DateTime? // Null if in progress
  ratingAtEntry Int
  createdAt    DateTime @default(now())

  qualifier    Qualifier @relation(fields: [qualifierId], references: [id])
  user         User      @relation(fields: [userId], references: [id])

  @@unique([qualifierId, userId])
  @@index([qualifierId, score])
}

model GlobalFinal {
  id        String   @id @default(cuid())
  seasonId  String
  skillId   String
  status    String // "UPCOMING" | "LIVE" | "ENDED"
  startAt   DateTime
  endAt     DateTime
  createdAt DateTime @default(now())
  
  finalists GlobalFinalist[]

  @@unique([seasonId, skillId])
}

model GlobalFinalist {
  id          String   @id @default(cuid())
  globalFinalId String
  userId      String
  region      Region
  qualifierId String
  qualifierRank Int
  seed        Int
  finalScore  Int?
  completedAt DateTime?

  final       GlobalFinal @relation(fields: [globalFinalId], references: [id])
  user        User        @relation(fields: [userId], references: [id])

  @@unique([globalFinalId, userId])
  @@index([globalFinalId, finalScore])
}


// --- PHASE 10: MONETIZATION & SCALE ---

model DailyWallet {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime @db.Date
  earned    Int      @default(0) // Daily earning cap tracking
  spent     Int      @default(0)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  
  @@unique([userId, date])
}

model CosmeticItem {
  id          String   @id @default(cuid())
  sku         String   @unique
  name        String
  type        String   // "AVATAR" | "FRAME" | "BACKGROUND" | "EMOTE"
  rarity      String   // "COMMON" | "RARE" | "EPIC" | "LEGENDARY"
  coinCost    Int
  isActive    Boolean  @default(true)
  metadata    Json?    // e.g. { "assetUrl": "..." }
  createdAt   DateTime @default(now())

  ownedBy     UserCosmetic[]
}

model UserCosmetic {
  id          String   @id @default(cuid())
  userId      String
  cosmeticId  String
  ownedAt     DateTime @default(now())
  
  user        User         @relation(fields: [userId], references: [id])
  cosmetic    CosmeticItem @relation(fields: [cosmeticId], references: [id])

  @@unique([userId, cosmeticId])
}

model BattlePass {
  id        String   @id @default(cuid())
  seasonId  String   @unique // One BP per season generally
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  tiers     BattlePassTier[]
  progress  UserBattlePassProgress[]
}

model BattlePassTier {
  id           String     @id @default(cuid())
  battlePassId String
  tier         Int        // 1, 2, 3...
  requiredXp   Int        // Cumulative or step
  rewardType   String     // "COINS" | "COSMETIC"
  rewardValue  String     // "100" or "avatar_robot_gold"
  
  battlePass   BattlePass @relation(fields: [battlePassId], references: [id])

  @@unique([battlePassId, tier])
}

model UserBattlePassProgress {
  id           String     @id @default(cuid())
  userId       String
  battlePassId String
  xpEarned     Int        @default(0)
  tierUnlocked Int        @default(0)
  claimedTiers Json       @default("[]") // Array of tier numbers
  updatedAt    DateTime   @updatedAt

  user         User       @relation(fields: [userId], references: [id])
  battlePass   BattlePass @relation(fields: [battlePassId], references: [id])

  @@unique([userId, battlePassId])
}

model Entitlement {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "PREMIUM" | "FAMILY_PARENT" | "FAMILY_CHILD"
  status    String   // "ACTIVE" | "INACTIVE"
  startsAt  DateTime
  endsAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId, type, status])
}

model PurchaseLog {
  id        String   @id @default(cuid())
  userId    String
  sku       String?  // Null if not a cosmetic (e.g. direct coin purchase)
  costCoins Int
  details   Json?
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
}

model IdempotencyKey {
  id        String   @id @default(cuid())
  userId    String
  key       String
  route     String
  createdAt DateTime @default(now())

  @@unique([userId, key, route])
}
